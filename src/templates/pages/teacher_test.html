{% extends "base.html" %}
{% block title %}–¢–∞—Ç–∞—Ä —Ç–µ–ª–µ–Ω–Ω”ô–Ω —Ç–µ—Å—Ç{% endblock %}
{% block description %}–¢”©—Ä–ª–µ —Ç–µ—Å—Ç–ª–∞—Ä, –∫–≤–∏–∑–ª–∞—Ä “Ø—Ç–∫”ô—Ä”ô–±–µ–∑{% endblock %}
<style>
    .question-card {
        margin-bottom: 20px;
        border-left: 4px solid #007bff;
    }
    .options-group {
        margin-left: 20px;
    }
    .result-correct {
        color: green;
        font-weight: bold;
    }
    .result-incorrect {
        color: red;
        font-weight: bold;
    }
</style>
<body>
    <div class="container py-4">
        <h1 class="text-center mb-4">
            {% if test_type == 'vocabulary' %}
                üìö –¢–µ—Å—Ç –ø–æ —Å–ª–æ–≤–∞—Ä–Ω–æ–º—É –∑–∞–ø–∞—Å—É
            {% elif test_type == 'grammar' %}
                üìù –¢–µ—Å—Ç –ø–æ –≥—Ä–∞–º–º–∞—Ç–∏–∫–µ
            {% endif %}
        </h1>

        <form id="testForm">
            {% for question in questions %}
            <div class="card question-card">
                <div class="card-body">
                    <h5 class="card-title">–í–æ–ø—Ä–æ—Å {{ loop.index }}</h5>
                    <p class="card-text">{{ question.question }}</p>

                    <div class="options-group">
                        {% for option in question.options %}
                        <div class="form-check">
                            <input class="form-check-input" type="radio"
                                   name="question_{{ question.id }}"
                                   id="q{{ question.id }}_opt{{ loop.index0 }}"
                                   value="{{ loop.index0 }}">
                            <label class="form-check-label" for="q{{ question.id }}_opt{{ loop.index0 }}">
                                {{ option }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}

            <div class="text-center mt-4">
                <button type="submit" class="btn btn-success btn-lg">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç</button>
                <a href="/tests" class="btn btn-secondary btn-lg">–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É —Ç–µ—Å—Ç–æ–≤</a>
            </div>
        </form>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
        <div id="results" class="mt-5" style="display: none;"></div>
    </div>

    <script>
        document.getElementById('testForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData();
            const answers = {};

            // –°–æ–±–∏—Ä–∞–µ–º –æ—Ç–≤–µ—Ç—ã
            document.querySelectorAll('input[type="radio"]:checked').forEach(input => {
                const questionId = input.name.replace('question_', '');
                answers[questionId] = parseInt(input.value);
            });

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            fetch('/submit-test/{{ test_type }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ answers: answers })
            })
            .then(response => response.json())
            .then(data => {
                displayResults(data);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ç–µ—Å—Ç–∞');
            });
        });

        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            let html = `
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞</h3>
                    </div>
                    <div class="card-body">
                        <h4>–û–±—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: ${results.score.toFixed(1)}%</h4>
                        <p>–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: ${results.correct_answers} –∏–∑ ${results.total_questions}</p>

                        <h5 class="mt-4">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è:</h5>
            `;

            results.details.forEach(detail => {
                const statusClass = detail.is_correct ? 'result-correct' : 'result-incorrect';
                const statusText = detail.is_correct ? '‚úì –ü—Ä–∞–≤–∏–ª—å–Ω–æ' : '‚úó –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ';

                html += `
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6>${detail.question}</h6>
                            <p class="${statusClass}">${statusText}</p>
                            <p><strong>–í–∞—à –æ—Ç–≤–µ—Ç:</strong> ${getAnswerText(detail.question_id, detail.user_answer)}</p>
                            <p><strong>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:</strong> ${getAnswerText(detail.question_id, detail.correct_answer)}</p>
                            <p><em>${detail.explanation}</em></p>
                        </div>
                    </div>
                `;
            });

            html += `
                        <div class="text-center mt-4">
                            <a href="/tests" class="btn btn-primary">–ü—Ä–æ–π—Ç–∏ –¥—Ä—É–≥–æ–π —Ç–µ—Å—Ç</a>
                            <button onclick="location.reload()" class="btn btn-secondary">–ü—Ä–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ</button>
                        </div>
                    </div>
                </div>
            `;

            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';

            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function getAnswerText(questionId, answerIndex) {
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ç–µ–∫—Å—Ç –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤
            const question = document.querySelector(`input[name="question_${questionId}"]`);
            if (question) {
                const labels = document.querySelectorAll(`input[name="question_${questionId}"]`);
                if (labels[answerIndex]) {
                    return labels[answerIndex].nextElementSibling.textContent;
                }
            }
            return `–í–∞—Ä–∏–∞–Ω—Ç ${answerIndex + 1}`;
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>