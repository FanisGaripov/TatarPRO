{% extends "base.html" %}
{% block title %}Татар теленнән тест{% endblock %}
{% block description %}Төрле тестлар, квизлар үткәрәбез{% endblock %}
{% block content %}
<style>
    .question-card {
        margin-bottom: 20px;
        border-left: 4px solid #007bff;
    }
    .options-group {
        margin-left: 20px;
    }
    .result-correct {
        color: green;
        font-weight: bold;
    }
    .result-incorrect {
        color: red;
        font-weight: bold;
    }
</style>
<body>
    <div class="container py-4">
        {% if test %}
        <h2 class="text-center mb-4">Тестның исеме: {{ test.title }}</h2>
        <h4 class="text-center mb-4">Тест турында: {{ test.description }}</h4>
        <h4 class="text-center mb-4">ID: {{ test.id }}</h4>
        {% endif %}

        <form id="testForm">
            {% for question in questions %}
            <div class="card question-card">
                <div class="card-body">
                    <h5 class="card-title">{{ loop.index }} нче сорау</h5>
                    <p class="card-text">{{ question.question }}</p>

                    <div class="options-group">
                        {% for option in question.options %}
                        <div class="form-check">
                            <input class="form-check-input" type="radio"
                                   name="question_{{ question.id }}"
                                   id="q{{ question.id }}_opt{{ loop.index0 }}"
                                   value="{{ loop.index0 }}">
                            <label class="form-check-label" for="q{{ question.id }}_opt{{ loop.index0 }}">
                                {{ option }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}

            <div class="text-center mt-4">
                <button type="submit" class="btn btn-success btn-lg">Җибәрергә</button>
                <a href="{{ url_for('tests_page') }}" class="btn btn-secondary btn-lg">Тестларга кире кайту</a>
            </div>
        </form>

        <!-- Результаты будут отображаться здесь -->
        <div id="results" class="mt-5" style="display: none;"></div>
    </div>

    <script>
        document.getElementById('testForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData();
            const answers = {};

            // Собираем ответы
            document.querySelectorAll('input[type="radio"]:checked').forEach(input => {
                const questionId = input.name.replace('question_', '');
                answers[questionId] = parseInt(input.value);
            });

            // Отправляем на сервер
            fetch('/submit-test/{{ test.id }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ answers: answers })
            })
            .then(response => response.json())
            .then(data => {
                displayResults(data);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Произошла ошибка при отправке теста');
            });
        });

        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            let html = `
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h3>Результаты теста</h3>
                    </div>
                    <div class="card-body">
                        <h4>Общий результат: ${results.score.toFixed(1)}%</h4>
                        <p>Правильных ответов: ${results.correct_answers} из ${results.total_questions}</p>

                        <h5 class="mt-4">Детализация:</h5>
            `;

            results.details.forEach(detail => {
                const statusClass = detail.is_correct ? 'result-correct' : 'result-incorrect';
                const statusText = detail.is_correct ? '✓ Правильно' : '✗ Неправильно';

                html += `
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6>${detail.question}</h6>
                            <p class="${statusClass}">${statusText}</p>
                            <p><strong>Ваш ответ:</strong> ${getAnswerText(detail.question_id, detail.user_answer)}</p>
                            <p><strong>Правильный ответ:</strong> ${getAnswerText(detail.question_id, detail.correct_answer)}</p>
                            <p><em>${detail.explanation}</em></p>
                        </div>
                    </div>
                `;
            });

            html += `
                        <div class="text-center mt-4">
                            <a href="/tests" class="btn btn-primary">Пройти другой тест</a>
                            <button onclick="location.reload()" class="btn btn-secondary">Пройти заново</button>
                        </div>
                    </div>
                </div>
            `;

            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';

            // Прокрутка к результатам
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function getAnswerText(questionId, answerIndex) {
            // В реальном приложении нужно сохранять текст вариантов ответов
            const question = document.querySelector(`input[name="question_${questionId}"]`);
            if (question) {
                const labels = document.querySelectorAll(`input[name="question_${questionId}"]`);
                if (labels[answerIndex]) {
                    return labels[answerIndex].nextElementSibling.textContent;
                }
            }
            return `Вариант ${answerIndex + 1}`;
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
{% endblock %}